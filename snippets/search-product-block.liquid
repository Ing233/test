{%- liquid
  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif

  assign product_url = product.url | within: collection

  if animation_type == blank
    assign animation_type = "cc-fade-in-up"
  endif

  assign primary_image = product.variants[0].featured_media.preview_image
  assign secondary_image = product.media[1].preview_image
  for med in product.media
    if med.preview_image == primary_image
      assign secondary_image = product.media[forloop.index].preview_image
      break
    endif
  endfor

  if settings.prod_show_videos
    assign videos = product.media | where: "media_type", "video"
    unless videos == blank
      for source in videos[0].sources
        if source != blank and source.format == "mp4"
          assign video_source = source
          break
        endif
      endfor

      assign mp4_url = video_source.url
    endunless
  endif

  assign product_has_swatches = false
  if settings.swatch_enabled and settings.prod_block_swatches and hide_swatches != true
    for product_option in product.options_with_values
      if settings.swatch_option_name == product_option.name
        assign product_has_swatches = true
        break
      endif
    endfor
  endif
-%}

{% assign show_color = true %}
{% if hidden_color %}
  {% assign show_color = false %}
{% endif %}

{% comment %} metafields: CNUM {% endcomment %}
{% assign all_hb_color_num = product.metafields.custom.product_tags.value["CNUM"] %}

{% comment %} metafields: TITLE {% endcomment %}
{% assign this_ql_subtitle = product.tags | where: 'TITLE_' %}


{%- comment -%}折扣{%- endcomment -%}
{% assign arr_discount_m =  product.metafields.custom.discount.value %}
{% assign hasdiscount = false %}
{% assign discoutVal = 0 %}
{% assign tag = '' %}
{% assign is_icon = false %}
{% for zk_value in arr_discount_m %}
  {% assign date_now = "now" | date: "%s" %}
  {% assign date_start = zk_value.start_time | replace_first: '_', ' '  | date: "%s" %}
  {% assign date_end = zk_value.end_time | replace_first: '_', ' '  | date: "%s" %}
  {% assign this_handle = zk_value.handle | handle %}
  
  {% if product.handle == this_handle and date_now > date_start and date_now < date_end %}
    {% assign hasdiscount = true %}
  {% endif %}


  {% if hasdiscount == true %}
      {% assign tag = zk_value.tag %}
      {% assign is_icon = zk_value.is_icon %}
      {% assign val = zk_value.discount_value | abs  | times: product.price %}
      {% assign discoutVal0 = product.price | times: 100 %}
      {% assign discoutVal = discoutVal0 | minus: val %}
      {% assign discoutVal = discoutVal | times: 0.1 | ceil %}
      {% assign discoutVal = discoutVal | times: 0.1 | ceil %}
      {% assign p = discoutVal | money %}
      {% assign pArr = p | split: '.' %}
  {% endif %}
{% endfor %}

{% assign oo = product.price | money %}
{% assign oPriceArr = oo | split: '.' %}


<div class="product-block cc-product-block column quarter {% unless product.available %} sold-out{% endunless %}
  {% if on_sale %} on-sale{% endif %}
  {% if settings.prod_hover == "second_image" %}hover-image{% endif %}
  {% if settings.prod_hover == "all_images" and product.images.size > 1 %}all-images{% endif %}
  {% if product.tags contains 'meta-layout-right' %}layout-right{% endif %}
  {% if settings.prod_label_layout == 'marquee_on_hover' %} product-block--marquee-on-hover {% endif%}
  {% if settings.quickbuy_enabled %}product-block--quickbuy{% endif %}
  {% if mp4_url != blank %}product-block--video{% endif %}
  {% if product_has_swatches %}product-block--has-swatches{% endif %}
  {{ product_class }}"
     data-loop-index="{{ i }}"
  {% if product.images.size > 1 %}
    {% if settings.prod_hover == "all_images" or product_has_swatches %}
      {%- liquid
        assign images = ""
        for image in product.images
          assign image_placeholder = image | img_url: '1x1' | replace: '_1x1.', '_{width}x.'
          assign images = images | append: "," | append: image_placeholder
        endfor
      -%}
      data-product-images="{{ images | remove_first: "," }}"
    {% endif %}
  {% endif %}
>

  <div class="product-block__inner">
    <!-- BEGIN SPT.WISHLIST -->
    <span class="spt-wishlist-element spt-icon spt-icon-heart-empty" data-spt-params="{productId:{{product.id}},urlName:'{{product.handle}}',variantId:{{product.variants[0].id}}}"></span>
    <!-- END SPT.WISHLIST -->

    <div class="image {% if settings.prod_hover == "second_image" and product.media.size > 1 %}image--hover-second {% if primary_image.aspect_ratio == secondary_image.aspect_ratio %}image--same-aspect-ratio{% endif %}{% endif %}">
      {% if settings.prod_label_layout contains 'marquee' %}
        <div class="product-marquee">
          {% render 'product-label', product: product %}
        </div>
      {% endif %}

      <div>
        <!-- raking 榜单 (ql20250201) -->
        {% assign num_show_top = 5 %}
        {% if show_top %}
          {% assign num_show_top = show_top | abs %}
        {% endif %}
        {% if ql_ranking and ql_ranking <= num_show_top %}
          {% assign page_title = page_handle | replace: '-', ' ' | replace: '_', ' ' %}
          <span class="product-label product-label--trending-top">
            <span>#0{{ql_ranking}} &nbsp;</span><span class="ql-fl-capitalize">{{page_title}}</span>
            
          </span>
        {% endif %}

        <!-- 长期折扣图标 -->
        {% if is_icon %}
          <a class="product-label product-label--long-discount" href="/collections/trending-deal">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="图层_1" x="0px" y="0px" viewBox="0 0 1000 1000" xml:space="preserve">
              <g>
                <path d="M272.2,870.8c-12.3,0-22.2-9.9-22.2-22.2V619.7c0-12.2,9.9-22.2,22.2-22.2c12.3,0,22.2,9.9,22.2,22.2v228.9   C294.4,860.8,284.5,870.8,272.2,870.8z"></path> 
                <path d="M523.7,870.8c-12.3,0-22.2-9.9-22.2-22.2v-315c0-12.2,9.9-22.2,22.2-22.2c12.2,0,22.2,9.9,22.2,22.2v315   C545.8,860.8,535.9,870.8,523.7,870.8z"></path> 
                <path d="M775.1,870.8c-12.2,0-22.2-9.9-22.2-22.2V447.4c0-12.3,9.9-22.2,22.2-22.2c12.2,0,22.2,9.9,22.2,22.2v401.2   C797.3,860.8,787.3,870.8,775.1,870.8z"></path> 
                <path d="M229.5,502.9c-45.2,0-75-3.1-79.7-3.6c-12.2-1.4-20.9-12.3-19.6-24.5c1.4-12.2,12.3-21,24.5-19.6   c4.5,0.5,451.3,46.4,624.1-253.9c6.1-10.6,19.7-14.3,30.3-8.2c10.6,6.1,14.3,19.7,8.2,30.3C674.6,471.3,373.7,502.9,229.5,502.9z"></path> 
                <path d="M869.8,140.4L849.1,311c-1,8.1-10.7,11.7-16.7,6.2L685.3,183.3c-6-5.5-3.3-15.4,4.6-17.2l167.9-36.7   C864.5,128,870.7,133.6,869.8,140.4z"></path>
              </g>
            </svg>
          </a>
        {% endif %}
      </div>
      <a data-cc-animate-click class="image-inner" href="{% if page_handle != blank %}{{ product_url }}?tending={{page_handle}}{% else %}{{ product_url }}{% endif %}" aria-label="{{ product.title | escape }}" tabindex="-1">
        <div class="image__first">
          {% if mp4_url != blank %}
            {% render 'inline-video', video: mp4_url, image: primary_image %}
          {% else %}
            {% render 'responsive-image', image: primary_image %}
          {% endif %}

          {%- comment -%}
          {% unless settings.prod_label_layout contains 'marquee' %}
            {% render 'product-label', product: product %}
          {% endunless %}
          {%- endcomment -%}
          

        </div>

        {% if settings.prod_hover == "second_image" and product.media.size > 1 %}
        <div class="image__second">
          {% render 'responsive-image', image: secondary_image, aspect_ratio: primary_image.aspect_ratio %}
        </div>
        {% endif %}

      </a>
      {%- if settings.quickbuy_enabled -%}
      <div class="cc-quick-buy-btn-container">
        {% if product_url contains '?' %}
          {% assign quick_url = product_url | append: '&view=quick' %}
        {% else %}
          {% assign quick_url = product_url | append: '?view=quick' %}
        {% endif %}
        
        <a href="{{ quick_url }}" data-cc-quick-buy class="button alt cc-quick-buy-btn">
          +
        </a>
      </div>
    {%- endif -%}
    </div>

    <div class="ql_product-text">
    {%- if settings.swatch_enabled and settings.prod_block_swatches and hide_swatches != true -%}
      {%- assign option_limit = 4 -%}
      {%- for product_option in product.options_with_values -%}
      {%- assign _ql_show_color_num = 0 -%}
      {%- if settings.swatch_option_name == product_option.name and show_color == true -%}
        {%- comment -%} COLOR {%- endcomment -%}
        <ul class="cc-swatches {% if settings.swatch_use_prod_images == true %}cc-swatches-prod-img cc-swatches-prod-img-{{ settings.swatch_prod_images_shape }}{% endif %}" data-option-name="{{ product_option.name | escape }}">
          {%- if product.options.size == 1 -%}
          
            {% assign arr_availableVariants = product.variants | where: 'available' %}
            {%- for variant in product.variants -%}
              {%- assign variant_image = variant.featured_media.preview_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}
              {% if _ql_show_color_num < option_limit %}
                {% if variant.available %}
                  {%- assign _ql_show_color_num = _ql_show_color_num | plus : 1  -%}
                {%  endif %}
                
                <li class="{% if variant.available == false %}hidden-switch{% endif %}">
                    <a rel="nofollow"
                        href="{{ product.url }}?variant={{ variant.id }}&default=M"
                       title="{{ variant.title | escape }}"
                       {% if variant.featured_media.preview_image %}
                       data-variant-image="{{ variant_image }}"
                       {% endif %}
                        class="{% unless variant.available %}unavailable{% endunless %} lazyload"
                          data-option-item="{{ variant.title | downcase | escape }}"
                          {% if variant.featured_media %}data-media="{{ variant.featured_media.id }}"{% endif %}
                    {% if settings.swatch_method == "image" and settings.swatch_use_prod_images == false  %}
                      data-bgset="{{ variant.title | handle | append: '.png' | file_img_url: '48x48', crop: 'center' }}"
                    {% elsif settings.swatch_use_prod_images == true %}
                      data-bgset="{{ variant.featured_media.preview_image | img_url: '72x', crop: 'center' }}"
                      style="{% if settings.swatch_prod_images_shape == "natural" %}padding-top: {{ 1 | divided_by: variant.featured_media.preview_image.aspect_ratio | times: 100 }}%;{% endif %}"
                    {% else %}
                      style="background-color:{{ variant.title | downcase | remove: ' ' | escape }}"
                    {% endif %}>
                      {{ variant.title }}
                  </a>
                  </li>
                {% endif %}
              {%- endfor -%}
              {%- assign all_hb_color_num = all_hb_color_num | minus: product.variants.size | plus: arr_availableVariants.size | minus: _ql_show_color_num  -%}
              {%- if all_hb_color_num > 0 -%}
                <li class="product-block__more-label" ql-data-type="test11"><span>&plus;{{ all_hb_color_num }}</span></li>
              {%- endif -%}
            {%- else -%}
              {%- assign product_option_position_0index = product_option.position | minus: 1 -%}
            
              {% assign arr_availableVariants = product_option.values | where: 'available' %}
              {%- for product_option_value in product_option.values -%}
                {%- liquid
                  assign option_value_variant = false
                  assign is_unavailable = true
                  for variant in product.variants
                    if variant.options[product_option_position_0index] == product_option_value
                      assign option_value_variant = variant
                      break
                    endif
                  endfor
                  for variant in product.variants
                    if variant.available and variant.options[product_option_position_0index] == product_option_value
                      assign is_unavailable = false
                      break
                    endif
                  endfor
                  assign variant_image = option_value_variant.featured_media.preview_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.'
                -%}
                {% if _ql_show_color_num < option_limit %}
                  {% if product_option_value.available %}
                     {%- assign _ql_show_color_num = _ql_show_color_num | plus : 1  -%}
                  {%  endif %}
                  <li class="{% if option_value_variant.featured_media.preview_image == primary_image  %}choosed{% endif %} {% if product_option_value.available == false %}hidden-switch{% endif %}"
                    data-value="{{product_option_value}}">
                    <a rel="nofollow"
                    href="{{ product.url }}?variant={{ option_value_variant.id }}&default=M"
                       title="{{ product_option_value | escape }}"
                       class="{% if is_unavailable %} unavailable{% endif %} lazyload"
                       {% if option_value_variant.featured_media.preview_image %}
                        data-variant-image="{{ variant_image }}"
                       {% endif %}
                        data-option-item="{{ product_option_value | downcase | escape }}"
                        {% if option_value_variant.featured_media %}data-media="{{ option_value_variant.featured_media.id }}"{% endif %}
                      {% if settings.swatch_method == "image" and settings.swatch_use_prod_images == false  %}
                        data-bgset="{{ product_option_value | handle | append: '.png' | file_img_url: '48x48', crop: 'center' }}"
                      {% elsif settings.swatch_use_prod_images == true %}
                        data-bgset="{{ option_value_variant.featured_media.preview_image | img_url: '72x', crop: 'center' }}"
                        style="{% if settings.swatch_prod_images_shape == "natural" %}padding-top: {{ 1 | divided_by: option_value_variant.featured_media.preview_image.aspect_ratio | times: 100 }}%;{% endif %}"
                      {% else %}
                        style="background-color:{{ product_option_value | downcase | remove: ' ' | escape }}"
                      {% endif %}>
                        {{ product_option_value }}
                  </a>
                  </li>
                {% endif %}
              {%- endfor -%}

              {% comment %} 剩余颜色数量 {% endcomment %}
              {%- assign all_hb_color_num = all_hb_color_num | minus: product_option.values.size  | plus: arr_availableVariants.size | minus: _ql_show_color_num  -%}
              {%- if all_hb_color_num > 0 -%}
                <li class="product-block__more-label"  ql-data-type="{{product_option.values.size}}"><span>&plus;{{ all_hb_color_num }}</span></li>
              {%- endif -%}
            {%- endif -%}
          </ul>

        {%- endif -%}

      {%- endfor -%}
    {%- endif -%}



    <a data-cc-animate-click href="{% if page_handle != blank %}{{ product_url }}?tending={{page_handle}}{% else %}{{ product_url }}{% endif %}" class="caption upper">
      {% if hidden_subtitle == nil or hidden_subtitle == false %}
        <span class="subtitle product-tags">
          {% if this_ql_subtitle.size > 0 %}
            {{this_ql_subtitle[0] | replace: 'TITLE_', '' }}
          {% endif %}
        </span>
      {% endif %}
      <span class="title">{{ product.title }}</span>

      {% if show_vendor %}
        <span class="vendor">{{ product.vendor }}</span>
      {% endif %}
    </a>
    <div class="price">
      {% if product.price_varies %}{{ 'products.listing.from' | t }}{% endif %}
      {%- comment -%} 折扣对比价 {%- endcomment -%}
      {% if hasdiscount and settings._usf_show_discount_price and settings._usf_show_original_price == false %}
        <span class="was-price theme-money">{{ product.price | money }}</span>
      {% elsif on_sale %}
        <span class="was-price theme-money">{{ product.compare_at_price | money }}</span>
      {% endif %}
      {% if hasdiscount and settings._usf_show_discount_price and settings._usf_show_original_price == false %}
        <span class="theme-money ql-red ql-weight500" data-theme-int="{{pArr[0]}}" {% if pArr.size > 1 %}data-theme-point=".{{pArr[1]}}"{% endif %}></span>
      {% else %}
        <span class="theme-money" data-theme-int="{{oPriceArr[0]}}" {% if oPriceArr.size > 1 %}data-theme-point=".{{oPriceArr[1]}}"{% endif %}></span>
      {% endif %}
     

      {% render 'unit-price', variant: product %}
      <!-- <div class="ql-bag-icon">
        <svg xmlns="http://www.w3.org/2000/svg" role="img" width="16px" height="16px" viewBox="0 0 24 24" aria-labelledby="plusIconTitle" stroke="#fff" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="miter" fill="none" color="#fff"> <title id="plusIconTitle">Plus</title> <path d="M17 12L7 12M12 7L12 17"></path> </svg>
      </div> -->

      {%- if settings.quickbuy_enabled -%}
          {% if product_url contains '?' %}
            {% assign quick_url = product_url | append: '&view=quick-mb' %}
          {% else %}
            {% assign quick_url = product_url | append: '?view=quick-mb' %}
          {% endif %}
          
          <a href="{{ quick_url }}" data-cc-quick-buy class="ql-bag-icon">
            <svg xmlns="http://www.w3.org/2000/svg" role="img" width="16px" height="16px" viewBox="0 0 24 24" aria-labelledby="plusIconTitle" stroke="#fff" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="miter" fill="none" color="#fff"> <title id="plusIconTitle">Plus</title> <path d="M17 12L7 12M12 7L12 17"></path> </svg>
          </a>
      {%- endif -%}

      {% if hasdiscount and settings._usf_show_discount_price == false %}
        <span data-id="{{product.id}}" class="ql-discount-tag">DEAL</span>
      {% endif %}
    </div>
    {% if hasdiscount and tag !="" %}
      <div class="ql-discount">{{tag}}</div>
    {% endif %}

    {% if settings.show_product_block_reviews %}
    <a data-cc-animate-click href="{{ product_url }}" class="themed-product-reviews" tabindex="-1">
      <span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span>
    </a>
    {% endif %}
    </div>
  </div>

  <div class="ql-mb-size">
    <div class="header">
      <p>SELECT SIZE</p>
      <span>{{product.title}}</span>
      <a href="#" data-modal-close="" class="modal-close">×</a>
    </div>
    {% assign hasSize = false %}
    {% for product_option in product.options_with_values %}
      {% if product_option.name != 'Color' and hasSize != true %}
      {%- comment -%} SIZE {%- endcomment -%}
      {% assign hasSize = true %}
        <ul class="clickyboxes cc-init ql-size-clickboxes" data-option-name="{{ product_option.name | escape }}">
          {%- if product.options.size == 1 -%}
          
            {%- assign _ql_show_color_num = 0 -%}
            {%- for variant in product.variants -%}
              
                    {%- assign _ql_show_color_num = _ql_show_color_num | plus : 1  -%}
                <li>
                  <a rel="nofollow"
                    href="#"
                    title="{{ variant.title | escape }}"
                      class="{% unless variant.available %}unavailable{% endunless %} lazyload"
                        data-option-item="{{ variant.title | downcase | escape }}"
                        {% if variant.featured_media %}data-media="{{ variant.featured_media.id }}"{% endif %}>
                    {{ variant.title }}
                </a>
                </li>
              
            {%- endfor -%}
          {%- else -%}
            {%- assign product_option_position_0index = product_option.position | minus: 1 -%}
          
            {%- assign _ql_show_color_num = 0 -%}
            {%- for product_option_value in product_option.values -%}
              {%- liquid
                assign option_value_variant = false
                assign is_unavailable = true
                for variant in product.variants
                  if variant.options[product_option_position_0index] == product_option_value
                    assign option_value_variant = variant
                    break
                  endif
                endfor
                for variant in product.variants
                  if variant.available and variant.options[product_option_position_0index] == product_option_value
                    assign is_unavailable = false
                    break
                  endif
                endfor
              -%}
              
                  {%- assign _ql_show_color_num = _ql_show_color_num | plus : 1  -%}
                <li>
                  <a rel="nofollow"
                    href="#"
                    data-href="{{ product.url }}?variant={{ option_value_variant.id }}"
                    title="{{ product_option_value | escape }}"
                    class="{% if is_unavailable %} unavailable{% endif %} lazyload"
                      data-option-item="{{ product_option_value | downcase | escape }}"
                      {% if option_value_variant.featured_media %}data-media="{{ option_value_variant.featured_media.id }}"{% endif %}>
                      {{ product_option_value }}
                  </a>
                </li>
            
            {%- endfor -%}
          
            
          {%- endif -%}
        </ul>
      {% endif %}
    {% endfor %}
  </div>
  
</div>


